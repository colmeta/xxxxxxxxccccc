<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clarity Pearl - Privacy Shield</title>
    <style>
        body { font-family: 'Inter', sans-serif; background: #0f172a; color: #e2e8f0; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: #1e293b; padding: 2rem; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); max-width: 400px; width: 100%; border: 1px solid #334155; }
        h1 { font-size: 1.5rem; margin-bottom: 1rem; color: #38bdf8; }
        p { font-size: 0.875rem; color: #94a3b8; margin-bottom: 1.5rem; }
        input { width: 100%; padding: 0.75rem; border-radius: 6px; border: 1px solid #475569; background: #0f172a; color: #fff; margin-bottom: 1rem; box-sizing: border-box; }
        button { width: 100%; padding: 0.75rem; border-radius: 6px; border: none; background: #38bdf8; color: #0f172a; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        button:hover { background: #0ea5e9; }
        .disclaimer { margin-top: 1rem; font-size: 0.75rem; text-align: center; opacity: 0.7; }
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .tab { flex: 1; background: #334155; color: #94a3b8; padding: 0.5rem; border-radius: 6px; border: none; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
        .tab.active { background: #38bdf8; color: #0f172a; font-weight: bold; }
    </style>
</head>
<body>
    <div class="card">
        <h1>üõ°Ô∏è Privacy Shield</h1>
        <p>Clarity Pearl respects your data rights. Enter your email or phone number below to <strong>permanently opt-out</strong> of our commercial intelligence database.</p>
        
        <div class="tabs">
            <button type="button" class="tab active" onclick="setMode('email')">Email</button>
            <button type="button" class="tab" onclick="setMode('phone')">Phone</button>
        </div>

        <form id="optOutForm">
            <input type="text" id="identifier" placeholder="name@company.com" required>
            <button type="submit" id="submitBtn">Remove My Data</button>
        </form>

        <p class="disclaimer">Requests are processed instantly via <strong>SHA-256 Hashing</strong> using your local device. <br>Your raw data never leaves your browser.</p>
        <div id="status" style="margin-top: 1rem; text-align: center; font-size: 0.8rem; min-height: 1.2rem;"></div>
    </div>

    <script>
        let mode = 'email';

        function setMode(newMode) {
            mode = newMode;
            document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
            document.querySelector(`button[onclick="setMode('${mode}')"]`).classList.add('active');
            
            const input = document.getElementById('identifier');
            if (mode === 'email') {
                input.placeholder = "name@company.com";
                input.type = "email";
            } else {
                input.placeholder = "+1 (555) 000-0000";
                input.type = "tel";
            }
            input.value = '';
            input.focus();
        }

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        document.getElementById('optOutForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const status = document.getElementById('status');
            const rawValue = document.getElementById('identifier').value;
            
            if (!rawValue) return;

            // Normalization Logic
            let cleanValue = rawValue.trim();
            if (mode === 'email') {
                cleanValue = cleanValue.toLowerCase();
            } else {
                // Remove all non-digits
                cleanValue = cleanValue.replace(/\D/g, '');
            }

            if (cleanValue.length < 5) {
                status.style.color = '#f87171'; // red
                status.innerText = "Please enter a valid identifier.";
                return;
            }

            btn.disabled = true;
            btn.innerText = "Processing...";

            try {
                const hash = await sha256(cleanValue);
                
                // REAL API CALL
                const response = await fetch('/api/opt-out', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hash: hash, type: mode })
                });

                if (!response.ok) {
                    throw new Error('Server error');
                }

                const result = await response.json();
                
                status.style.color = '#4ade80'; // green
                status.innerText = result.message || "Success! Your hash (" + hash.substring(0, 8) + "...) is blocked.";
                
            } catch (err) {
                console.error(err);
                status.style.color = '#f87171';
                status.innerText = "Error processing request.";
            } finally {
                btn.disabled = false;
                btn.innerText = "Remove My Data";
                document.getElementById('identifier').value = '';
            }
        });
    </script>
</body>
</html>
